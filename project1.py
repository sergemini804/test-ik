import logging
import sqlite3
import requests
import json
import re
import os
from dotenv import load_dotenv
from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional, Set, Tuple
from openpyxl import Workbook
import io
import telebot
from telebot import apihelper, types

load_dotenv()

API_TOKEN = os.getenv('API_TOKEN')
DB_NAME = "results.db"
try:
    ADMIN_IDS = [int(id_str) for id_str in os.getenv('ADMIN_IDS', '').split(',') if id_str.strip()]
except:
    ADMIN_IDS = []

AI_API_URL = os.getenv('AI_API_URL')
AI_API_KEY = os.getenv('AI_API_KEY')
AI_MODEL = os.getenv('AI_MODEL')

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

STATE_IDLE = "idle"
STATE_C4_PROCESS = "c4_answering"
STATE_WAIT_FIO = "wait_fio"

@dataclass
class UserSession:
    state: str = STATE_IDLE
    
    c1_data: Dict[str, Any] = field(
        default_factory=lambda: {
            'm1_answers': set(), 
            'm2_idx': 0, 'm2_answers': [], 
            'm3_answers': set()
        }
    )
    c2_data: Dict[str, Any] = field(
        default_factory=lambda: {
            'm4_idx': 0, 'm4_score': 0, 'm4_temp': set(), 'm4_answers': [],
            'm5_answers': set(), 
            'm6_idx': 0, 'm6_answers': [], 'm6_score': 0
        }
    )
    c3_data: Dict[str, Any] = field(
        default_factory=lambda: {
            'm7_idx': 0, 'm7_answers': [],
            'm8_idx': 0, 'm8_answers': [],
            'm10_idx': 0, 'm10_answers': []
        }
    )
    c4_data: Dict[str, Any] = field(
        default_factory=lambda: {
            'current_q_idx': 0,
            'user_answers': []
        }
    )

class ContentProvider:
    LEVEL_NAMES = {
        1: "–†–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π (–ù–∏–∑–∫–∏–π)",
        2: "–ß–∞—Å—Ç–∏—á–Ω–æ-–ø–æ–∏—Å–∫–æ–≤—ã–π (–°—Ä–µ–¥–Ω–∏–π)",
        3: "–¢–≤–æ—Ä—á–µ—Å–∫–∏-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π (–í—ã—Å–æ–∫–∏–π)"
    }
    FULL_DESCRIPTIONS = {
        'c1': {
            1: "–í—ã –Ω–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø–æ–∑–Ω–∞–Ω–∏—é –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —è–≤–ª–µ–Ω–∏–π –∏ –æ–≤–ª–∞–¥–µ–Ω–∏—é —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ –Ω–∞—É—á–Ω–æ–≥–æ –ø–æ–∑–Ω–∞–Ω–∏—è. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–ª—è –í–∞—Å —Ü–µ–Ω–Ω–æ—Å—Ç—å—é.",
            2: "–í—ã –ø—Ä–æ—è–≤–ª—è–µ—Ç–µ —á–∞—Å—Ç–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø–æ–∑–Ω–∞–Ω–∏—é –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —è–≤–ª–µ–Ω–∏–π. –í—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –µ—é —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏.",
            3: "–í–∞–º —Å–≤–æ–π—Å—Ç–≤–µ–Ω–µ–Ω —É—Å—Ç–æ–π—á–∏–≤—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø–æ–∑–Ω–∞–Ω–∏—é –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —è–≤–ª–µ–Ω–∏–π. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å —è–≤–ª—è–µ—Ç—Å—è –¥–ª—è –í–∞—Å –æ–¥–Ω–æ–π –∏–∑ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π, —Å–ø–æ—Å–æ–±—Å—Ç–≤—É—é—â–µ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —Ä–æ—Å—Ç—É."
        },
        'c2': {
            1: "–í–∞—à–∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ä–Ω—ã. –í—ã —Å–ª–∞–±–æ –≤–ª–∞–¥–µ–µ—Ç–µ –º–µ—Ç–æ–¥–∞–º–∏ –Ω–∞—É—á–Ω–æ–≥–æ –ø–æ–∑–Ω–∞–Ω–∏—è –∏ –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç–µ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏—è –≤ –∏—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.",
            2: "–í—ã –≤–ª–∞–¥–µ–µ—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –ø–æ–Ω—è—Ç–∏—è–º–∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –í—ã —Å–ø–æ—Å–æ–±–Ω—ã –ø—Ä–∏–º–µ–Ω—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –Ω–∞—É—á–Ω–æ–≥–æ –ø–æ–∑–Ω–∞–Ω–∏—è, –Ω–æ –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.",
            3: "–í–∞—à–∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è –Ω–æ—Å—è—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä; –≤—ã —É–≤–µ—Ä–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –º–µ—Ç–æ–¥—ã –Ω–∞—É—á–Ω–æ–≥–æ –ø–æ–∑–Ω–∞–Ω–∏—è –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞."
        },
        'c3': {
            1: "–í—ã —Å—Ç—Ä–æ–∏—Ç–µ —Å–≤–æ—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ –∑–∞—Ä–∞–Ω–µ–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ, –Ω–µ –ø—Ä–æ—è–≤–ª—è—è —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞. –í—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ –æ–±—Ä–∞–∑—Ü—É –∏ –∏–∑–±–µ–≥–∞–µ—Ç–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–π.",
            2: "–í—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ —É—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫—É—é –ø—Ä–∞–∫—Ç–∏–∫—É. –í—ã –æ—Ç–∫—Ä—ã—Ç—ã –Ω–æ–≤–æ–º—É, –Ω–æ –≤–Ω–µ–¥—Ä—è–µ—Ç–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ.",
            3: "–í—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ –≤—ã—Å–æ–∫—É—é —Ç–≤–æ—Ä—á–µ—Å–∫—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å. –í—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Å—Ç—Ä–µ–º–∏—Ç–µ—Å—å –∫ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—é, —Å–æ–∑–¥–∞–µ—Ç–µ –∞–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –∞–∫—Ç–∏–≤–Ω–æ –≤–Ω–µ–¥—Ä—è–µ—Ç–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏."
        }
    }

    INTRO_TEXT = (
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –∫–æ–ª–ª–µ–≥–∞! üëã\n"
        "–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å –≤ —á–∞—Ç-–±–æ—Ç–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤–∞—à–µ–π <b>–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã</b>.\n\n"
        "<b>–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?</b> –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–µ–¥–∞–≥–æ–≥ ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –Ω–æ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å, "
        "—Å–ø–æ—Å–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å —Å–≤–æ—é –ø—Ä–∞–∫—Ç–∏–∫—É. "
        "–≠—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –æ—Ü–µ–Ω–∏—Ç—å —Å–≤–æ—é –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —ç—Ç–æ–π —Ä–æ–ª–∏.\n\n"
        "<b>–ß—Ç–æ –æ—Ü–µ–Ω–∏–≤–∞–µ–º?</b> –í—Å–µ–≥–æ —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞:\n"
        "1. –¶–µ–Ω–Ω–æ—Å—Ç–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –Ω–æ–≤—à–µ—Å—Ç–≤–∞–º –∏ –ø–æ–∏—Å–∫—É.\n"
        "2. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å ‚Äî –∑–Ω–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –∏ —É–º–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∏–µ–º—ã.\n"
        "3. –¢–≤–æ—Ä—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—é.\n\n"
        "<b>–ö–∞–∫ —ç—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç?</b> –í–∞–º –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–µ—Ä–∏—é –Ω–µ–±–æ–ª—å—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–µ–π—Å-—Å–∏—Ç—É–∞—Ü–∏–π. "
        "–û—Ç–≤–µ—á–∞–π—Ç–µ –±—ã—Å—Ç—Ä–æ, –∏—Å—Ö–æ–¥—è –∏–∑ –≤–∞—à–µ–≥–æ –æ–ø—ã—Ç–∞.\n"
        "<b>–í—Ä–µ–º—è:</b> –æ–∫–æ–ª–æ 25‚Äì40 –º–∏–Ω—É—Ç."
    )

    CRITERIA_INTROS = {
        'c1': (
            "<b>–ß–∞—Å—Ç—å 1. –ê–∫—Å–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –ø–µ–¥–∞–≥–æ–≥–∞.</b>\n\n"
            "–û–Ω –ø–æ–∑–≤–æ–ª–∏—Ç –≤—ã—è–≤–∏—Ç—å –≤–∞—à—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –º–æ—Ç–∏–≤–∞—Ü–∏—é: –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã —Å—Ç—Ä–µ–º–∏—Ç–µ—Å—å –∫ –Ω–æ–≤—à–µ—Å—Ç–≤–∞–º "
            "–∏ –ø–æ–∑–Ω–∞–Ω–∏—é –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —è–≤–ª–µ–Ω–∏–π, —Ü–µ–Ω–∏—Ç–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è –∏ –≤–∏–¥–∏—Ç–µ –≤ –Ω–∏—Ö –æ—Å–Ω–æ–≤—É "
            "–¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞."
        ),
        'c2': (
            "<b>–ß–∞—Å—Ç—å 2. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –ø–µ–¥–∞–≥–æ–≥–∞.</b>\n\n"
            "–û–Ω –ø–æ–∑–≤–æ–ª–∏—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –∑–Ω–∞–Ω–∏–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è "
            "–∏ —É—Ä–æ–≤–µ–Ω—å –≤–ª–∞–¥–µ–Ω–∏—è –ø—Ä–∏–µ–º–∞–º–∏ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á."
        ),
        'c3': (
            "<b>–ß–∞—Å—Ç—å 3. –õ–∏—á–Ω–æ—Å—Ç–Ω–æ-—Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä—ã –ø–µ–¥–∞–≥–æ–≥–∞.</b>\n\n"
            "–û–Ω –ø–æ–∑–≤–æ–ª–∏—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à—É —Ç–≤–æ—Ä—á–µ—Å–∫—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ "
            "–∏ –ª–∏—á–Ω–æ—Å—Ç–Ω–æ–º—É —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—é."
        ),
        'c4': (
            "<b>–ß–∞—Å—Ç—å 4. –¶–µ–Ω–Ω–æ—Å—Ç–Ω–æ-—Å–º—ã—Å–ª–æ–≤–æ–π –∫—Ä–∏—Ç–µ—Ä–∏–π.</b>\n\n"
            "–ó–¥–µ—Å—å –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞. –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏."
        )
    }

    METHODOLOGY_INSTRUCTIONS = {
        'text_m1': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 1.</b> –ê–Ω–∫–µ—Ç–∞ –ø–æ –≤—ã—è–≤–ª–µ–Ω–∏—é —É –ø–µ–¥–∞–≥–æ–≥–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–æ–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∫ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–ª—è –í–∞—Å —Ü–µ–Ω–Ω–æ—Å—Ç–∏, –æ—Ç–º–µ—Ç—å—Ç–µ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –æ—Ç–≤–µ—Ç—ã.",
        'text_m2': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 2.</b> –¢–µ—Å—Ç ¬´–†–µ—Ñ–ª–µ–∫—Å–∏—è –Ω–∞ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ¬ª.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –≤—ã–±–∏—Ä–∞—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.",
        'text_m3': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 3.</b> –ê–Ω–∫–µ—Ç–∞ ¬´–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–µ–¥–∞–≥–æ–≥–∞ –∫ –æ—Å–≤–æ–µ–Ω–∏—é –Ω–æ–≤—à–µ—Å—Ç–≤¬ª.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–µ –±–æ–ª–µ–µ —Ç—Ä–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å: —á—Ç–æ –≤–∞—Å –ø–æ–±—É–∂–¥–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞—Ç—å—Å—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º–∏ –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å –Ω–æ–≤—à–µ—Å—Ç–≤–∞?",
        
        'text_m4': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 4.</b> –ú–µ—Ç–æ–¥ –Ω–µ–∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑ –¥–æ–ª–≥–∏—Ö —Ä–∞–∑–¥—É–º–∏–π –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∏—Å—Ö–æ–¥—è –∏–∑ —Å–≤–æ–∏—Ö –ø–µ—Ä–≤—ã—Ö –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –∏ —É–±–µ–∂–¥–µ–Ω–∏–π. –û—Ç–≤–µ—Ç –Ω–∞–ø–µ—á–∞—Ç–∞–π—Ç–µ –≤ –æ–∫–Ω–æ (–Ω–µ –±–æ–ª–µ–µ 5 —Å–ª–æ–≤).", # –≠—Ç–æ C4
        
        'text_m5': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 5.</b> –¢–µ—Å—Ç ¬´–ó–Ω–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è¬ª.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –≤—ã–±–∏—Ä–∞—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.\n–í–æ–ø—Ä–æ—Å—ã 2, 6, 7 –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é—Ç –≤—ã–±–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤.",
        'text_m6': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 6.</b> –ê–Ω–∫–µ—Ç–∞ –Ω–∞ –≤—ã—è–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —É–º–µ–Ω–∏–π –ø–µ–¥–∞–≥–æ–≥–∞-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ —É–º–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –ø–µ–¥–∞–≥–æ–≥—É-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—é, –Ω–∞ –≤–∞—à –≤–∑–≥–ª—è–¥.",
        'text_m7': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 7.</b> –†–µ—à–µ–Ω–∏–µ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç —Ä–µ—à–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–π –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–∏.",
        
        'text_m8': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 8.</b> –¢–µ—Å—Ç ¬´–ö–∞–∫–æ–π –í–∞—à —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª?¬ª.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.",
        'text_m9': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 9.</b> –ê–Ω–∫–µ—Ç–∞ ¬´–í–æ—Å–ø—Ä–∏–∏–º—á–∏–≤–æ—Å—Ç—å –ø–µ–¥–∞–≥–æ–≥–æ–≤ –∫ –Ω–æ–≤—à–µ—Å—Ç–≤–∞–º¬ª.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.",
        'text_m10': "<b>–ú–µ—Ç–æ–¥–∏–∫–∞ 10.</b> –ê–Ω–∫–µ—Ç–∞ –ø–æ –≤—ã—è–≤–ª–µ–Ω–∏—é —É –ø–µ–¥–∞–≥–æ–≥–∞ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏—è –∫ —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—é.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞."
    }

    GLOBAL_RECOMMENDATIONS = {
        1: (
            "<b>–í–∞—à —É—Ä–æ–≤–µ–Ω—å ‚Äî –†–ï–ü–†–û–î–£–ö–¢–ò–í–ù–´–ô (–ù–∞—á–∞–ª—å–Ω—ã–π)</b>\n\n"
            "<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n"
            "1. –ù–∞—á–Ω–∏—Ç–µ —Å –º–∞–ª–æ–≥–æ. –ü–æ—Å–µ—Ç–∏—Ç–µ —Å–µ–º–∏–Ω–∞—Ä –∏–ª–∏ –¥–∏—Å–∫—É—Å—Å–∏—é –Ω–∞ —Ç–µ–º—É ¬´–ó–∞—á–µ–º —É—á–∏—Ç–µ–ª—é –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å?¬ª. "
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–µ—Å—Ç–∏ –∫—Ä–∞—Ç–∫–∏–π –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–π –¥–Ω–µ–≤–Ω–∏–∫.\n"
            "2. –û—Å–≤–æ–π—Ç–µ –æ–¥–∏–Ω –ø—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–Ω–∫–µ—Ç—É –≤ –Ø–Ω–¥–µ–∫—Å.–§–æ—Ä–º–∞—Ö). "
            "–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ –æ–¥–Ω–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏.\n"
            "3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É –≤ —Ä–æ–ª–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è. –ù–∞–π–¥–∏—Ç–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞.\n"
            "4. –ù–∞—á–Ω–∏—Ç–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ —Å –∫—Ä–∞—Ç–∫–æ–≥–æ —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω–æ–≥–æ —ç—Å—Å–µ."
        ),
        2: (
            "<b>–í–∞—à —É—Ä–æ–≤–µ–Ω—å ‚Äî –ß–ê–°–¢–ò–ß–ù–û-–ü–û–ò–°–ö–û–í–´–ô (–°—Ä–µ–¥–Ω–∏–π)</b>\n\n"
            "<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n"
            "1. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –æ—Ç –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∫ —É—á–∞—Å—Ç–∏—é. –ü—Ä–∏–º–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ –≤ –ø–µ–¥. –¥–µ–±–∞—Ç–∞—Ö, –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä—É—è –¥–∞–Ω–Ω—ã–º–∏.\n"
            "2. –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –∏ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –Ω–µ–±–æ–ª—å—à–æ–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–µ–∫—Ç. –û—Å–≤–æ–π—Ç–µ –±–∞–∑—ã eLibrary/CyberLeninka.\n"
            "3. –°—Ç–∞–Ω—å—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–∞. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å—Ç–µ–Ω–¥–æ–≤–æ–≥–æ –¥–æ–∫–ª–∞–¥–∞. "
            "–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–æ–∞–≤—Ç–æ—Ä—Å—Ç–≤–æ.\n"
            "4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥—ã —Ñ–æ—Ä–º–∏—Ä—É—é—â–µ–≥–æ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è. –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–æ–ø–æ–ª–Ω—è–π—Ç–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ."
        ),
        3: (
            "<b>–í–∞—à —É—Ä–æ–≤–µ–Ω—å ‚Äî –¢–í–û–†–ß–ï–°–ö–ò-–ò–°–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô (–í—ã—Å–æ–∫–∏–π)</b>\n\n"
            "<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n"
            "1. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–π—Ç–µ —Å–≤–æ—é –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é. –í—ã—Å—Ç—É–ø–∞–π—Ç–µ –≤ —Ä–æ–ª–∏ ¬´–Ω–æ—Å–∏—Ç–µ–ª—è –∫—É–ª—å—Ç—É—Ä—ã¬ª.\n"
            "2. –†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏. –û—Å–≤–æ–π—Ç–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–µ—Ç–æ–¥—ã –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö. "
            "–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä—Å–∫–∏–π –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å.\n"
            "3. –í—ã—Å—Ç—É–ø–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –ø—Ä–æ—Ñ. —Å–æ–±—ã—Ç–∏—è (–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏). –í–æ–∑—å–º–∏—Ç–µ –º–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ –Ω–∞–¥ –∫–æ–ª–ª–µ–≥–∞–º–∏.\n"
            "4. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã–π —Å–µ–º–∏–Ω–∞—Ä. –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –≤ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–æ–µ –ø–æ—Å–æ–±–∏–µ –∏–ª–∏ —Å—Ç–∞—Ç—å—é."
        )
    }

    M1_ITEMS = {1:1, 2:1, 3:1, 4:0, 5:1, 6:1, 7:1, 8:0, 9:0, 10:0, 11:1}
    M1_TEXTS = {
        1: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–∫—Ä—É–∂–∞—é—â–µ–π –ø–µ–¥. –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", 2: "–°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏",
        3: "–û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–π", 4: "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ –∞–º–±–∏—Ü–∏–π", 5: "–ì–ª—É–±–æ–∫–æ–µ –ø–æ–∑–Ω–∞–Ω–∏–µ —è–≤–ª–µ–Ω–∏–π",
        6: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏", 7: "–ü—Ä–æ—Ñ. —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ", 8: "–°–∞–º–æ—É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
        9: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö", 10: "–û–±–æ–≥–∞—â–µ–Ω–∏–µ –æ–ø—ã—Ç–∞", 11: "–¶–µ–Ω–Ω–æ—Å—Ç–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –ø–æ–∑–Ω–∞–Ω–∏—é"
    }
    M2_QS = [
        ("–ö–∞–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –í–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç?", [("–¶–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª–µ–Ω–Ω—ã–π", 3), ("–¢—Ä—É–¥–æ–ª—é–±–∏–≤—ã–π", 2), ("–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", 1)]),
        ("–ó–∞ —á—Ç–æ –≤–∞—Å —Ü–µ–Ω—è—Ç –∫–æ–ª–ª–µ–≥–∏?", [("–ó–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", 2), ("–ó–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ—Å—Ç—å", 1), ("–ó–∞ —ç—Ä—É–¥–∏—Ü–∏—é", 3)]),
        ("–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?", [("–ü—É—Å—Ç–∞—è —Ç—Ä–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏", 1), ("–ì–ª—É–±–æ–∫–æ –Ω–µ –≤–Ω–∏–∫–∞–ª", 2), ("–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ", 3)]),
        ("–ß—Ç–æ –º–µ—à–∞–µ—Ç —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è?", [("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏", 3), ("–ù–µ—Ç —É—Å–ª–æ–≤–∏–π", 2), ("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –≤–æ–ª–∏", 1)]),
        ("–ó–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏—è –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?", [("–ù–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª", 2), ("–ó–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏–π –Ω–µ—Ç", 3), ("–¢–æ—á–Ω–æ –Ω–µ –∑–Ω–∞—é", 1)]),
        ("–ö–∞–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç?", [("–¢—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π", 3), ("–ù–∞—Å—Ç–æ–π—á–∏–≤—ã–π", 2), ("–°–Ω–∏—Å—Ö–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π", 1)]),
        ("–ö–∞–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç (2)?", [("–†–µ—à–∏—Ç–µ–ª—å–Ω—ã–π", 2), ("–°–æ–æ–±—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–π", 3), ("–õ—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π", 1)]),
        ("–ü–æ–∑–∏—Ü–∏—è –≤ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?", [("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π", 3), ("–ö—Ä–∏—Ç–∏–∫", 2), ("–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä", 1)]),
        ("–ö–∞–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–∑–≤–∏—Ç—ã —Å–∏–ª—å–Ω–µ–µ?", [("–°–∏–ª–∞ –≤–æ–ª–∏", 2), ("–£–ø–æ—Ä—Å—Ç–≤–æ", 3), ("–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å", 1)]),
        ("–ß—Ç–æ –¥–µ–ª–∞–µ—Ç–µ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è?", [("–õ—é–±–∏–º–æ–µ –¥–µ–ª–æ", 2), ("–ß–∏—Ç–∞—é", 3), ("–° –¥—Ä—É–∑—å—è–º–∏", 1)]),
        ("–ò–Ω—Ç–µ—Ä–µ—Å –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è?", [("–ú–µ—Ç–æ–¥–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è", 1), ("–ü–µ–¥–∞–≥–æ–≥–∏–∫–∞/–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è", 2), ("–ò–Ω–Ω–æ–≤–∞—Ü–∏–∏", 3)]),
        ("–ì–¥–µ –º–æ–≥–ª–∏ –±—ã —Å–µ–±—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å?", [("–í –ø—Ä–∞–∫—Ç–∏–∫–µ", 1), ("–í –Ω–æ–≤–æ–º –ø—Ä–æ–µ–∫—Ç–µ", 3), ("–ù–µ –∑–Ω–∞—é", 2)]),
        ("–ö–∞–∫–∏–º –≤–∞—Å —Å—á–∏—Ç–∞—é—Ç –¥—Ä—É–∑—å—è?", [("–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º", 3), ("–î–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–º", 2), ("–û—Ç–∑—ã–≤—á–∏–≤—ã–º", 1)]),
        ("–ö–∞–∫–æ–π –ø—Ä–∏–Ω—Ü–∏–ø –±–ª–∏–∂–µ?", [("–ü—Ä–æ–∂–∏–≤–∏ –∫–∞–∫ —Ö–æ—á–µ—à—å", 1), ("–†–∞–∑–≤–∏—Ç–∏–µ —á–µ—Ä–µ–∑ –∂–∏–∑–Ω—å", 3), ("–ù–∞—Å–ª–∞–∂–¥–µ–Ω–∏–µ –≤ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ", 2)]),
        ("–ö—Ç–æ –±–ª–∏–∂–µ –∫ –∏–¥–µ–∞–ª—É?", [("–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π", 1), ("–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π", 3), ("–¢–≤–æ—Ä—á–µ—Å–∫–∏–π", 2)]),
        ("–£–¥–∞—Å—Ç—Å—è –ª–∏ –¥–æ–±–∏—Ç—å—Å—è –º–µ—á—Ç—ã?", [("–î—É–º–∞—é, –¥–∞", 3), ("–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –¥–∞", 2), ("–ö–∞–∫ –ø–æ–≤–µ–∑–µ—Ç", 1)]),
        ("–ß—Ç–æ –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏?", [("–û–¥–æ–±—Ä–µ–Ω–∏–µ", 2), ("–ù–µ –∑–Ω–∞—é –µ—â–µ", 1), ("–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", 3)]),
        ("–ß—Ç–æ –ø—Ä–µ–¥–ø–æ—á–ª–∏ –±—ã?", [("–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", 2), ("–ù–æ–≤—É—é —à–∫–æ–ª—É", 3), ("–ñ–∏—Ç—å –≤ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ", 1)])
    ]
    M3_ITEMS = {1:0, 2:1, 3:0, 4:0, 5:0, 6:1, 7:0, 8:1, 9:0, 10:0, 11:0, 12:0, 13:1}
    M3_TEXTS = {
        1: "–û—Å–æ–∑–Ω–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤", 2: "–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–∏—Ç—è–∑–∞–Ω–∏–π",
        3: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö", 4: "–ñ–µ–ª–∞–Ω–∏–µ —Å–æ–∑–¥–∞—Ç—å —à–∫–æ–ª—É", 5: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –Ω–æ–≤–∏–∑–Ω–µ",
        6: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ª–∏–¥–µ—Ä—Å—Ç–≤–µ", 7: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø–æ–∏—Å–∫–µ", 8: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–∏",
        9: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º", 10: "–ñ–µ–ª–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞–Ω–∏—è", 11: "–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —Ä–∏—Å–∫–µ",
        12: "–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã", 13: "–°—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –±—ã—Ç—å –æ—Ü–µ–Ω–µ–Ω–Ω—ã–º"
    }

    M4_QS = [
        {"t": "s", "q": "–ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –í–∞—Å ‚Äì —ç—Ç–æ:", "o": [("–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã", 0), ("–ù–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è", 1), ("–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å", 2)]},
        {"t": "m", "q": "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞—É—á–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:", "o": ["–ú–µ—Ç–æ–¥—ã", "–ó–∞–¥–∞—á–∏", "–ü—Ä–æ–¥—É–∫—Ç", "–†–µ—Å—É—Ä—Å—ã", "–û–±—ä–µ–∫—Ç", "–ö—Ä–∏—Ç–µ—Ä–∏–∏", "–ü—Ä–µ–¥–º–µ—Ç", "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ì–∏–ø–æ—Ç–µ–∑–∞"], "c": {0, 1, 4, 6, 7, 8}, "w": 0.5},
        {"t": "s", "q": "–¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ‚Äì —ç—Ç–æ:", "o": [("–†–µ–∑—É–ª—å—Ç–∞—Ç", 1), ("–í–æ–ø—Ä–æ—Å", 0), ("–û—Ç–≤–µ—Ç", 0)]},
        {"t": "s", "q": "–ì–∏–ø–æ—Ç–µ–∑–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ‚Äì —ç—Ç–æ:", "o": [("–í–æ–ø—Ä–æ—Å", 0), ("–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç", 1), ("–°—Ñ–µ—Ä–∞ –ø–æ–∏—Å–∫–∞", 0)]},
        {"t": "s", "q": "–ú–µ—Ç–æ–¥—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ‚Äì —ç—Ç–æ:", "o": [("–ó–∞–º—ã—Å–µ–ª", 0), ("–ó–∞–¥–∞—á–∏", 0), ("–°–ø–æ—Å–æ–±—ã –ø–æ–∑–Ω–∞–Ω–∏—è", 1)]},
        {"t": "m", "q": "–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã:", "o": ["–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ", "–û–±—Ä–∞–±–æ—Ç–∫–∞", "–¢–µ—Å—Ç—ã", "–ë–µ—Å–µ–¥–∞", "–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ê–Ω–∞–ª–∏–∑ –ª–∏—Ç-—Ä—ã", "–°—Ä–∞–≤–Ω. –∞–Ω–∞–ª–∏–∑", "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç", "–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"], "c": {0, 5, 6, 7}, "w": 0.5},
        {"t": "m", "q": "–≠–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã:", "o": ["–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ", "–û–±—Ä–∞–±–æ—Ç–∫–∞", "–¢–µ—Å—Ç—ã", "–ë–µ—Å–µ–¥–∞", "–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ê–Ω–∞–ª–∏–∑ –ª–∏—Ç-—Ä—ã", "–°—Ä–∞–≤–Ω. –∞–Ω–∞–ª–∏–∑", "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç", "–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"], "c": {1, 2, 3, 4, 8, 9}, "w": 0.5}
    ]
    M5_ITEMS = {1:1, 2:1, 3:1, 4:1, 5:0, 6:0, 7:1, 8:1, 9:0, 10:1, 11:1, 12:0, 13:0}
    M5_TEXTS = {
        1: "–£–º–µ–Ω–∏–µ –≤–∏–¥–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—É", 2: "–£–º–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã", 3: "–£–º–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å",
        4: "–£–º–µ–Ω–∏–µ –≤—ã–¥–≤–∏–≥–∞—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É", 5: "–£–º–µ–Ω–∏–µ –≤–∏–¥–µ—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É —É—á–µ–Ω–∏–∫–∞", 6: "–£–º–µ–Ω–∏–µ —Ä–µ—à–∞—Ç—å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏",
        7: "–£–º–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", 8: "–£–º–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å", 9: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É",
        10: "–û—Ü–µ–Ω–∫–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", 11: "–†–µ—Ñ–ª–µ–∫—Å–∏—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏", 12: "–£—á–∏—Ç—ã–≤–∞—Ç—å –∫—É–ª—å—Ç. —Ä–∞–∑–ª–∏—á–∏—è",
        13: "–û—Ü–µ–Ω–∏–≤–∞—Ç—å —É—á–µ–±–Ω—É—é –¥–µ—è—Ç-—Å—Ç—å"
    }
    M6_QS = [
        ("–ê–Ω–∞–ª–∏–∑ –í–ü–† –ø–æ–∫–∞–∑–∞–ª –Ω–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —É–º–µ–Ω–∏–π. –í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è:", [("–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –æ—à–∏–±–∫–∞–º–∏", 1), ("–ü–æ–¥–æ–±—Ä–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è", 2), ("–ò–∑—É—á–∏—Ç—å –ª–∏—Ç. –∏ –Ω–∞–π—Ç–∏ –ø—Ä–∏–µ–º—ã", 3)]),
        ("–ó–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏—è —Å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≥–∏–ø–æ—Ç–µ–∑—ã. –í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è:", [("–ü–æ–∫–∞–∑–∞—Ç—å –æ–±—Ä–∞–∑—Ü—ã", 1), ("–£—Ä–æ–∫–∏-–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è", 2), ("–ê–Ω–∞–ª–∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –ª–∏—Ç-—Ä—ã", 3)]),
        ("–£—Å–ª–æ–≤–∏–µ –¥–ª—è –µ—Å—Ç-–Ω–∞—É—á. –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏:", [("–ú–µ—Ç–æ–¥. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", 1), ("–í–Ω–µ—É—Ä–æ—á–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å", 2), ("–ú–µ–∂–ø—Ä–µ–¥–º–µ—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è", 3)]),
        ("–ì–∏–ø–æ—Ç–µ–∑–∞ –æ–± –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–∏. –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?", [("–î–∏–∫—Ç–∞–Ω—Ç—ã", 1), ("–ö–∞—Ä—Ç–æ—á–∫–∏", 2), ("–¶–∏—Ñ—Ä–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã", 3)]),
        ("–°–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ. –í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è:", [("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ–µ–∫—Ç", 1), ("–í—ã—è—Å–Ω–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É", 2), ("–ò–∑–º–µ–Ω–∏—Ç—å –ø–ª–∞–Ω", 3)]),
        ("–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏. –°–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–π—Ç–µ:", [("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞", 1), ("–ü—Ä–æ–µ–∫—Ç", 2), ("–ü—Ä–æ—Ñ–ø—Ä–æ–±–∞", 3)]),
        ("–ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –†–æ–¥–∏–Ω—ã. –í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è:", [("–ú–µ—Ç–æ–¥. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", 1), ("–û–±–º–µ–Ω –æ–ø—ã—Ç–æ–º", 2), ("–ù–æ–≤—ã–µ —Ñ–æ—Ä–º—ã —Ä–∞–±–æ—Ç—ã", 3)]),
        ("–î–µ—Ç–∏ –Ω–µ –ø–æ–Ω–∏–º–∞—é—Ç —Å—É—â–Ω–æ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏:", [("–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω", 1), ("–°–æ–æ—Ç–Ω–µ—Å—Ç–∏ –æ–ø—ã—Ç", 2), ("–û–±—Å—É–¥–∏—Ç—å —Å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º", 3)])
    ]

    GENERIC_TESTS = {
        'm7': [
            ("–ú–∏—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω:", [("–î–∞", 3), ("–ù–µ—Ç", 1), ("–ö–æ–µ –≤ —á–µ–º", 2)]),
            ("–°–º–æ–∂–µ—Ç–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö:", [("–î–∞", 3), ("–ù–µ—Ç", 1), ("–ò–Ω–æ–≥–¥–∞", 2)]),
            ("–í–∞—à–∏ –∏–¥–µ–∏ –ø—Ä–∏–Ω–µ—Å–ª–∏ –±—ã –ø—Ä–æ–≥—Ä–µ—Å—Å:", [("–î–∞", 3), ("–ü—Ä–∏ —É—Å–ª–æ–≤–∏—è—Ö", 1), ("–í –Ω–µ–∫–æ—Ç–æ—Ä–æ–π —Å—Ç–µ–ø–µ–Ω–∏", 2)]),
            ("–°–º–æ–∂–µ—Ç–µ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –±—É–¥—É—â–µ–º:", [("–î–∞", 3), ("–ú–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ", 1), ("–í–æ–∑–º–æ–∂–Ω–æ", 2)]),
            ("–û—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ –Ω–∞—á–∏–Ω–∞–Ω–∏–µ:", [("–î–∞", 3), ("–î—É–º–∞—é, —Å–º–æ–≥—É", 1), ("–ß–∞—Å—Ç–æ", 2)]),
            ("–î–µ–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –∑–Ω–∞–µ—Ç–µ:", [("–ü—Ä–∏–≤–ª–µ–∫–∞–µ—Ç", 3), ("–ù–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç", 1), ("–ó–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–µ–ª–∞", 2)]),
            ("–ñ–µ–ª–∞–Ω–∏–µ –¥–æ–±–∏—Ç—å—Å—è —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–∞ –≤ –Ω–æ–≤–æ–º:", [("–î–∞", 3), ("–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Å—å", 1), ("–ï—Å–ª–∏ –Ω—Ä–∞–≤–∏—Ç—Å—è", 2)]),
            ("–•–æ—Ç–∏—Ç–µ –∑–Ω–∞—Ç—å –≤—Å–µ –æ –ª—é–±–∏–º–æ–º –¥–µ–ª–µ:", [("–î–∞", 3), ("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ–µ", 1), ("–õ—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ", 2)]),
            ("–ü—Ä–∏ –Ω–µ—É–¥–∞—á–µ:", [("–£–ø–æ—Ä—Å—Ç–≤—É—é", 3), ("–ú–∞—Ö–Ω—É —Ä—É–∫–æ–π", 1), ("–ü—Ä–æ–¥–æ–ª–∂–∞—é", 2)]),
            ("–ü—Ä–æ—Ñ–µ—Å—Å–∏—é –≤—ã–±–∏—Ä–∞—Ç—å –∏—Å—Ö–æ–¥—è –∏–∑:", [("–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π", 3), ("–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏", 1), ("–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤", 2)]),
            ("–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ:", [("–î–∞", 3), ("–ù–µ—Ç", 1), ("–ì–¥–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å", 2)]),
            ("–í—Å–ø–æ–º–Ω–∏—Ç—å –±–µ—Å–µ–¥—É:", [("–î–∞", 3), ("–í—Å–µ–≥–æ –Ω–µ –º–æ–≥—É", 1), ("–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ", 2)]),
            ("–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–ª–æ–≤–æ –Ω–∞ –Ω–µ–∑–Ω–∞–∫–æ–º–æ–º —è–∑—ã–∫–µ:", [("–î–∞", 3), ("–õ–µ–≥–∫–æ–µ", 1), ("–ù–µ —Å–æ–≤—Å–µ–º", 2)]),
            ("–í —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è:", [("–ù–∞–µ–¥–∏–Ω–µ", 3), ("–í –∫–æ–º–ø–∞–Ω–∏–∏", 1), ("–ë–µ–∑—Ä–∞–∑–ª–∏—á–Ω–æ", 2)]),
            ("–ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ:", [("–û—Ç–ª–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ", 3), ("–ë–æ–ª–µ–µ-–º–µ–Ω–µ–µ", 1), ("–ù–µ –≤—Å–µ —É–¥–∞–ª–æ—Å—å", 2)]),
            ("–ö–æ–≥–¥–∞ –æ–¥–Ω–∏:", [("–ú–µ—á—Ç–∞—é –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ", 3), ("–ò—â—É –∑–∞–Ω—è—Ç–∏–µ", 1), ("–ú–µ—á—Ç–∞—é –æ —Ä–∞–±–æ—Ç–µ", 2)]),
            ("–ò–¥–µ—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç:", [("–í—Å–µ–≥–¥–∞", 3), ("–ù–∞–µ–¥–∏–Ω–µ", 1), ("–í —Ç–∏—à–∏–Ω–µ", 2)]),
            ("–û—Ç—Å—Ç–∞–∏–≤–∞–µ—Ç–µ –∏–¥–µ—é:", [("–ú–æ–≥—É –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è", 3), ("–û—Å—Ç–∞–Ω—É—Å—å –ø—Ä–∏ —Å–≤–æ–µ–º", 1), ("–ò–∑–º–µ–Ω—é –µ—Å–ª–∏ –¥–∞–≤–ª–µ–Ω–∏–µ", 2)])
        ],
        'm8': [
            ("–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–ø—ã—Ç–æ–º?", [("–í—Å–µ–≥–¥–∞", 3), ("–ò–Ω–æ–≥–¥–∞", 2), ("–ù–∏–∫–æ–≥–¥–∞", 1)]),
            ("–°–∞–º–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ?", [("–í—Å–µ–≥–¥–∞", 3), ("–ò–Ω–æ–≥–¥–∞", 2), ("–ù–∏–∫–æ–≥–¥–∞", 1)]),
            ("–ü–µ–¥. –∏–¥–µ–∏?", [("–í—Å–µ–≥–¥–∞", 3), ("–ò–Ω–æ–≥–¥–∞", 2), ("–ù–∏–∫–æ–≥–¥–∞", 1)]),
            ("–ù–∞—É—á–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã?", [("–í—Å–µ–≥–¥–∞", 3), ("–ò–Ω–æ–≥–¥–∞", 2), ("–ù–∏–∫–æ–≥–¥–∞", 1)]),
            ("–ü—Ä–æ–≥–Ω–æ–∑ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?", [("–í—Å–µ–≥–¥–∞", 3), ("–ò–Ω–æ–≥–¥–∞", 2), ("–ù–∏–∫–æ–≥–¥–∞", 1)]),
            ("–û—Ç–∫—Ä—ã—Ç—ã –Ω–æ–≤–æ–º—É?", [("–í—Å–µ–≥–¥–∞", 3), ("–ò–Ω–æ–≥–¥–∞", 2), ("–ù–∏–∫–æ–≥–¥–∞", 1)])
        ],
        'm10': [
            ("–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π?", [("–î–∞", 2), ("–†–∞–∑–¥—É–º—ã–≤–∞—é", 1), ("–ù–µ—Ç", 0)]),
            ("–û–±–æ–±—â–∞–µ—Ç–µ –æ–ø—ã—Ç?", [("–î–∞", 2), ("–ü–æ–Ω–∏–º–∞—é, –Ω–æ –Ω–µ—Ç", 1), ("–ù–µ—Ç", 0)]),
            ("–§–æ—Ä–º–∞ –æ–±–æ–±—â–µ–Ω–∏—è?", [("–î–æ–∫–ª–∞–¥/–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å/–°—Ç–∞—Ç—å—è", 1), ("–ù–µ—Ç", 0), ("–î—Ä—É–≥–æ–µ", 0)]),
            ("–ö–æ–ª-–≤–æ —Å—Ç–∞—Ç–µ–π –∑–∞ 3 –≥–æ–¥–∞:", [("0", 0), ("1-3", 1), ("–ë–æ–ª–µ–µ 3", 2)]),
            ("–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤?", [("–î–∞", 2), ("–û–±–¥—É–º—ã–≤–∞—é", 1), ("–ù–µ—Ç", 0)]),
            ("–ö—É—Ä—Å—ã –ø–æ–≤—ã—à–µ–Ω–∏—è?", [("1 —Ä–∞–∑ –≤ 3 –≥–æ–¥–∞", 1), ("–ï–∂–µ–≥–æ–¥–Ω–æ", 2), ("–ù–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑", 3)]),
            ("–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∫—É—Ä—Å–æ–≤?", [("–°–∞–º (–¥–µ—Ñ–∏—Ü–∏—Ç—ã)", 2), ("–°–∞–º (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å)", 1), ("–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è", 0)]),
            ("–ö—É—Ä—Å—ã –ø–æ –∏—Å—Å–ª. –∫—É–ª—å—Ç—É—Ä–µ?", [("–î–∞", 2), ("–í–æ–∑–º–æ–∂–Ω–æ", 1), ("–ù–µ—Ç", 0)]),
            ("–ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ?", [("–î–∞", 2), ("–ñ–µ–ª–∞–ª –±—ã", 1), ("–ù–µ—Ç", 0)])
        ]
    }

    C4_PROMPTS = [
        "–î–ª—è –º–µ–Ω—è –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ ‚Äì —ç—Ç–æ‚Ä¶",
        "–ó–Ω–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã‚Ä¶",
        "–ö–æ–≥–¥–∞ —è —Å—Ç–∞–ª–∫–∏–≤–∞—é—Å—å —Å –Ω–æ–≤–æ–π –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π, —è‚Ä¶",
        "–ù–∞—É—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –º–µ–Ω—è ‚Äì —ç—Ç–æ‚Ä¶",
        "–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–Ω–µ‚Ä¶",
        "–£–º–µ–Ω–∏–µ –≤—ã–¥–≤–∏–≥–∞—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É –≤ –º–æ–µ–π —Ä–∞–±–æ—Ç–µ‚Ä¶",
        "–ò–∑—É—á–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ –≤ –ø–µ–¥–∞–≥–æ–≥–∏–∫–µ –º–µ–Ω—è –ø–æ–±—É–∂–¥–∞–µ—Ç‚Ä¶",
        "–ë–µ–∑ –≤–ª–∞–¥–µ–Ω–∏—è –º–µ—Ç–æ–¥–∞–º–∏ –Ω–∞—É—á–Ω–æ–≥–æ –ø–æ–∑–Ω–∞–Ω–∏—è –ø–µ–¥–∞–≥–æ–≥‚Ä¶"
    ]


class DatabaseManager:
    def __init__(self, db_name: str):
        self.db_name = db_name
        self._init_db()

    def _init_db(self):
        with sqlite3.connect(self.db_name) as conn:
            conn.execute('''
                CREATE TABLE IF NOT EXISTS results (
                    user_id INTEGER PRIMARY KEY,
                    fio TEXT DEFAULT '',
                    c1_res TEXT, c1_score REAL, c1_level INTEGER, c1_details TEXT,
                    c2_res TEXT, c2_score REAL, c2_level INTEGER, c2_details TEXT,
                    c3_res TEXT, c3_score REAL, c3_level INTEGER, c3_details TEXT,
                    c4_res TEXT, c4_score REAL, c4_level INTEGER, c4_details TEXT,
                    total_res TEXT
                )
            ''')
            try:
                conn.execute("ALTER TABLE results ADD COLUMN c1_level INTEGER")
                conn.execute("ALTER TABLE results ADD COLUMN c2_level INTEGER")
                conn.execute("ALTER TABLE results ADD COLUMN c3_level INTEGER")
                conn.execute("ALTER TABLE results ADD COLUMN c4_level INTEGER")
            except: pass
            try:
                conn.execute("ALTER TABLE results ADD COLUMN fio TEXT DEFAULT ''")
            except: pass
            try:
                conn.execute("ALTER TABLE results ADD COLUMN c1_details TEXT")
                conn.execute("ALTER TABLE results ADD COLUMN c2_details TEXT")
                conn.execute("ALTER TABLE results ADD COLUMN c3_details TEXT")
                conn.execute("ALTER TABLE results ADD COLUMN c4_details TEXT")
            except: pass

    def get_fio(self, user_id: int) -> Optional[str]:
        with sqlite3.connect(self.db_name) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT fio FROM results WHERE user_id = ?", (user_id,))
            row = cursor.fetchone()
            if row and row[0]: return row[0]
            return None

    def save_fio(self, user_id: int, fio: str):
        with sqlite3.connect(self.db_name) as conn:
            cursor = conn.cursor()
            cursor.execute("INSERT OR IGNORE INTO results (user_id) VALUES (?)", (user_id,))
            cursor.execute("UPDATE results SET fio = ? WHERE user_id = ?", (fio, user_id))

    def get_results(self, user_id: int) -> Dict:
        with sqlite3.connect(self.db_name) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM results WHERE user_id = ?", (user_id,))
            row = cursor.fetchone()
            if row: return dict(row)
            return {}

    def get_all_results(self) -> List[sqlite3.Row]:
        with sqlite3.connect(self.db_name) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM results")
            return cursor.fetchall()

    def save_result(self, user_id: int, criterion: str, result_text: str, score: float, level: int = 0, details: Dict = None):
        col_text = f"{criterion}_res"
        col_score = f"{criterion}_score" if criterion != 'total' else None
        col_level = f"{criterion}_level" if criterion != 'total' else None
        col_details = f"{criterion}_details" if criterion != 'total' else None
        
        details_json = json.dumps(details, ensure_ascii=False) if details else None

        with sqlite3.connect(self.db_name) as conn:
            cursor = conn.cursor()
            cursor.execute("INSERT OR IGNORE INTO results (user_id) VALUES (?)", (user_id,))
            if col_score and col_level:
                cursor.execute(f"UPDATE results SET {col_text} = ?, {col_score} = ?, {col_level} = ?, {col_details} = ? WHERE user_id = ?", (result_text, score, level, details_json, user_id))
            else:
                cursor.execute(f"UPDATE results SET {col_text} = ? WHERE user_id = ?", (result_text, user_id))

class QuizBot:
    def __init__(self, token: str, db_manager: DatabaseManager):
        self.bot = telebot.TeleBot(token)
        self.db = db_manager
        self.sessions: Dict[int, UserSession] = {}
        self.content = ContentProvider()
        self._register_handlers()

    def _get_session(self, user_id: int) -> UserSession:
        if user_id not in self.sessions:
            self.sessions[user_id] = UserSession()
        return self.sessions[user_id]

    def _safe_edit(self, chat_id: int, message_id: int, text: str,
                   reply_markup: Optional[types.InlineKeyboardMarkup] = None):
        try:
            self.bot.edit_message_text(
                text=text, chat_id=chat_id, message_id=message_id,
                reply_markup=reply_markup, parse_mode="HTML"
            )
        except apihelper.ApiTelegramException as e:
            if "message is not modified" not in str(e):
                logging.error(f"TG Error: {e}")

    def _calc_level(self, score: float, low_max: float, med_max: float) -> int:
        if score <= low_max: return 1
        if score <= med_max: return 2
        return 3

    
    def _get_ai_c4_analysis(self, qa_list: List[Tuple[str, str]]) -> Tuple[str, float, int]:
        qa_text = "\n".join([f"–í–æ–ø—Ä–æ—Å: {q}\n–û—Ç–≤–µ—Ç: {a}" for q, a in qa_list])
        
        system_prompt = (
            "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –º–µ—Ç–æ–¥–∏—Å—Ç-–ø—Å–∏—Ö–æ–ª–æ–≥, –æ—Ü–µ–Ω–∏–≤–∞—é—â–∏–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –∫—É–ª—å—Ç—É—Ä—É —É—á–∏—Ç–µ–ª—è."
            "–¢–µ–±–µ –¥–∞–Ω—ã –Ω–µ–æ–∫–æ–Ω—á–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Ç–æ, –∫–∞–∫ —É—á–∏—Ç–µ–ª—å –∏—Ö –∑–∞–∫–æ–Ω—á–∏–ª.\n"
            "–¢–í–û–Ø –ó–ê–î–ê–ß–ê:\n"
            "1. –û—Ü–µ–Ω–∏—Ç—å –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 3 –±–∞–ª–ª–æ–≤:\n"
            "   - 1 –±–∞–ª–ª (–†–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π): –§–æ—Ä–º–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥, —Å–∫—É–∫–∞, –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å, –Ω–µ–≥–∞—Ç–∏–≤, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞.\n"
            "   - 2 –±–∞–ª–ª–∞ (–ß–∞—Å—Ç–∏—á–Ω–æ-–ø–æ–∏—Å–∫–æ–≤—ã–π): –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã, —Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–¥–∞—á.\n"
            "   - 3 –±–∞–ª–ª–∞ (–¢–≤–æ—Ä—á–µ—Å–∫–∏–π): –ì–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ, —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ, –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å.\n"
            "2. –ü–æ—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—É –±–∞–ª–ª–æ–≤ (–º–∞–∫—Å–∏–º—É–º 24).\n"
            "3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å: 8-15 (–†–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π/–ù–∏–∑–∫–∏–π), 16-19 (–ß–∞—Å—Ç–∏—á–Ω–æ-–ø–æ–∏—Å–∫–æ–≤—ã–π/–°—Ä–µ–¥–Ω–∏–π), 20-24 (–¢–≤–æ—Ä—á–µ—Å–∫–∏–π/–í—ã—Å–æ–∫–∏–π).\n"
            "4. –ù–∞–ø–∏—Å–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥, –æ–±—Ä–∞—â–∞—è—Å—å –∫ —É—á–∏—Ç–µ–ª—é –Ω–∞ '–í—ã'.\n"
            "–û–¢–í–ï–¢ –í–ï–†–ù–ò –°–¢–†–û–ì–û –í JSON —Ñ–æ—Ä–º–∞—Ç–µ: {\"score\": <—á–∏—Å–ª–æ>, \"level_id\": <1, 2 –∏–ª–∏ 3>, \"text\": \"<–¢–µ–∫—Å—Ç –≤—ã–≤–æ–¥–∞>\"}"
        )

        try:
            response = requests.post(
                AI_API_URL,
                headers={"Authorization": f"Bearer {AI_API_KEY}", "Content-Type": "application/json"},
                json={
                    "model": AI_MODEL,
                    "messages": [
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": qa_text}
                    ]
                }, timeout=30
            )
            data = response.json()
            content = data['choices'][0]['message']['content']
            
            cleaned = re.sub(r'```json\s*|\s*```', '', content).strip()
            parsed = json.loads(cleaned)
            
            return parsed['text'], float(parsed['score']), int(parsed['level_id'])
            
        except Exception as e:
            logging.error(f"AI C4 Error: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑. –û—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.", 0, 1


    def _register_handlers(self):
        self.bot.message_handler(commands=['start'])(self.handle_start)
        self.bot.callback_query_handler(func=lambda c: c.data == "menu")(self.handle_menu_callback)
        self.bot.callback_query_handler(func=lambda c: c.data == "my_results")(self.handle_show_results)
        self.bot.callback_query_handler(func=lambda c: c.data == "global_result")(self.handle_global_result)
        
        self.bot.message_handler(commands=['admin'])(self.handle_admin)
        self.bot.callback_query_handler(func=lambda c: c.data == "admin_export")(self.handle_export)


        self.bot.message_handler(content_types=['text'])(self.handle_text_input)

        self.bot.callback_query_handler(func=lambda c: c.data == "c1_start")(self.c1_intro)
        self.bot.callback_query_handler(func=lambda c: c.data == "c1_real_start")(self.c1_start_test)
        self.bot.callback_query_handler(func=lambda c: c.data.startswith("c1_m1_"))(self.c1_m1_handler)
        self.bot.callback_query_handler(func=lambda c: c.data.startswith("c1_m2_"))(self.c1_m2_handler)
        self.bot.callback_query_handler(func=lambda c: c.data.startswith("c1_m3_"))(self.c1_m3_handler)
        self.bot.callback_query_handler(func=lambda c: c.data == "c1_done")(self.c1_finish)
        
        self.bot.callback_query_handler(func=lambda c: c.data == "c2_start")(self.c2_intro)
        self.bot.callback_query_handler(func=lambda c: c.data == "c2_real_start")(self.c2_start_test)
        self.bot.callback_query_handler(func=lambda c: c.data.startswith("c2_m4_"))(self.c2_m4_handler)
        self.bot.callback_query_handler(func=lambda c: c.data.startswith("c2_m5_"))(self.c2_m5_handler)
        self.bot.callback_query_handler(func=lambda c: c.data.startswith("c2_m6_"))(self.c2_m6_handler)
        

        self.bot.callback_query_handler(func=lambda c: c.data == "c3_start")(self.c3_intro)
        self.bot.callback_query_handler(func=lambda c: c.data == "c3_real_start")(self.c3_start_test)
        self.bot.callback_query_handler(func=lambda c: c.data.startswith("c3_seq_"))(self.c3_seq_handler)
        
        self.bot.callback_query_handler(func=lambda c: c.data == "c4_start")(self.c4_intro)
        self.bot.callback_query_handler(func=lambda c: c.data == "c4_real_start")(self.c4_start_test)

    def handle_start(self, message: types.Message):
        chat_id = message.chat.id
        fio = self.db.get_fio(chat_id)
        
        self.bot.send_message(chat_id, self.content.INTRO_TEXT, parse_mode="HTML")
        
        if not fio:
            self.bot.send_message(chat_id, "‚ùó –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ <b>–§–∞–º–∏–ª–∏—é –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ</b>:", parse_mode="HTML")
            self._get_session(chat_id).state = STATE_WAIT_FIO
        else:
            self.bot.send_message(chat_id, f"–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫: <b>{fio}</b>", parse_mode="HTML")
            self._get_session(chat_id).state = STATE_IDLE
            self.show_menu(chat_id)

    def handle_menu_callback(self, call: types.CallbackQuery):
        self.bot.answer_callback_query(call.id)
        self._get_session(call.message.chat.id).state = STATE_IDLE
        self.show_menu(call.message.chat.id)

    def show_menu(self, chat_id: int):
        fio = self.db.get_fio(chat_id)
        if not fio:
            self.bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ –§–ò–û, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ–Ω—é.")
            self._get_session(chat_id).state = STATE_WAIT_FIO
            return

        res = self.db.get_results(chat_id)
        c1, c2, c3, c4 = res.get('c1_res'), res.get('c2_res'), res.get('c3_res'), res.get('c4_res')
        
        keyboard = types.InlineKeyboardMarkup(row_width=1)
        keyboard.add(
            types.InlineKeyboardButton(f"{'‚úÖ ' if c1 else ''}–ö—Ä–∏—Ç–µ—Ä–∏–π 1: –ê–∫—Å–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π", callback_data="c1_start"),
            types.InlineKeyboardButton(f"{'‚úÖ ' if c2 else ''}–ö—Ä–∏—Ç–µ—Ä–∏–π 2: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π", callback_data="c2_start"),
            types.InlineKeyboardButton(f"{'‚úÖ ' if c3 else ''}–ö—Ä–∏—Ç–µ—Ä–∏–π 3: –õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π", callback_data="c3_start"),
            types.InlineKeyboardButton(f"{'‚úÖ ' if c4 else ''}–ö—Ä–∏—Ç–µ—Ä–∏–π 4: –¶–µ–Ω–Ω–æ—Å—Ç–Ω–æ-—Å–º—ã—Å–ª–æ–≤–æ–π", callback_data="c4_start"),
            types.InlineKeyboardButton("üìä –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data="my_results"),
            types.InlineKeyboardButton("üèÜ –û–ë–©–ò–ô –í–´–í–û–î", callback_data="global_result")
        )
        self.bot.send_message(chat_id, "<b>–ú–µ–Ω—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", reply_markup=keyboard, parse_mode="HTML")

    def handle_show_results(self, call: types.CallbackQuery):
        self.bot.answer_callback_query(call.id)
        res = self.db.get_results(call.message.chat.id)
        found = False
        for key in ['c1_res', 'c2_res', 'c3_res', 'c4_res', 'total_res']:
            val = res.get(key)
            if val:
                self.bot.send_message(call.message.chat.id, val, parse_mode="HTML")
                found = True
        if not found:
            self.bot.send_message(call.message.chat.id, "–í—ã –µ—â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç–µ—Å—Ç—ã.")
        
        kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–ú–µ–Ω—é", callback_data="menu"))
        self.bot.send_message(call.message.chat.id, "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é:", reply_markup=kb)

    def c4_intro(self, call: types.CallbackQuery):
        if self.db.get_results(call.message.chat.id).get('c4_res'):
             return self.bot.answer_callback_query(call.id, "–£–∂–µ –ø—Ä–æ–π–¥–µ–Ω–æ!")
        
        kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç", callback_data="c4_real_start"))
        self._safe_edit(call.message.chat.id, call.message.message_id, self.content.CRITERIA_INTROS['c4'], reply_markup=kb)

    def c4_start_test(self, call: types.CallbackQuery):
        chat_id = call.message.chat.id
        session = self._get_session(chat_id)
        session.state = STATE_C4_PROCESS
        session.c4_data = {'current_q_idx': 0, 'user_answers': []}
        
        self.bot.send_message(chat_id, self.content.METHODOLOGY_INSTRUCTIONS['text_m4'], parse_mode="HTML")
        self._send_next_c4_question(chat_id)

    def _send_next_c4_question(self, chat_id: int):
        session = self._get_session(chat_id)
        idx = session.c4_data['current_q_idx']
        
        if idx >= len(self.content.C4_PROMPTS):
            self.bot.send_message(chat_id, "‚è≥ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏–Ω—è—Ç—ã. –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...")
            
            ai_text, score, level = self._get_ai_c4_analysis(session.c4_data['user_answers'])
            
            final_text = (
                f"üß† <b>–†–ï–ó–£–õ–¨–¢–ê–¢ (–ö—Ä–∏—Ç–µ—Ä–∏–π 4)</b>\n\n"
                f"{ai_text}\n\n"
                f"–û—Ü–µ–Ω–∫–∞ –ò–ò: {score} –±–∞–ª–ª–æ–≤\n"
                f"–£—Ä–æ–≤–µ–Ω—å: {self.content.LEVEL_NAMES.get(level, '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}"
            )
            
            self.db.save_result(chat_id, 'c4', final_text, score, level, details=session.c4_data['user_answers'])
            session.state = STATE_IDLE
            
            kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–í –º–µ–Ω—é", callback_data="menu"))
            self.bot.send_message(chat_id, final_text, reply_markup=kb, parse_mode="HTML")
            return

        q_text = self.content.C4_PROMPTS[idx]
        self.bot.send_message(chat_id, f"<b>–í–æ–ø—Ä–æ—Å {idx+1}/{len(self.content.C4_PROMPTS)}:</b>\n\n{q_text}", parse_mode="HTML")

    def handle_text_input(self, message: types.Message):
        chat_id = message.chat.id
        session = self._get_session(chat_id)
        
        if session.state == STATE_WAIT_FIO:
            fio = message.text.strip()
            if len(fio) < 5:
                self.bot.send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –§–ò–û (–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ).")
                return
            self.db.save_fio(chat_id, fio)
            self.bot.send_message(chat_id, f"‚úÖ –°–ø–∞—Å–∏–±–æ, {fio}! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")
            session.state = STATE_IDLE
            self.show_menu(chat_id)
            
        elif session.state == STATE_C4_PROCESS:
            idx = session.c4_data['current_q_idx']
            question = self.content.C4_PROMPTS[idx]
            answer = message.text
            session.c4_data['user_answers'].append((question, answer))
            
            session.c4_data['current_q_idx'] += 1
            self._send_next_c4_question(chat_id)
        else:
            pass

    def handle_global_result(self, call: types.CallbackQuery):
        chat_id = call.message.chat.id
        res = self.db.get_results(chat_id)
        

        if not all([res.get('c1_res'), res.get('c2_res'), res.get('c3_res'), res.get('c4_res')]):
            self.bot.answer_callback_query(call.id, "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ 4 –∫—Ä–∏—Ç–µ—Ä–∏—è!", show_alert=True)
            return
        
        self._safe_edit(chat_id, call.message.message_id, "‚è≥ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è...")

        l1 = res.get('c1_level', 0)
        l2 = res.get('c2_level', 0)
        l3 = res.get('c3_level', 0)
        l4 = res.get('c4_level', 0)
        
        avg_level_float = (l1 + l2 + l3 + l4) / 4.0
        if avg_level_float < 1.5:
            final_level_id = 1
        elif avg_level_float < 2.5:
            final_level_id = 2
        else:
            final_level_id = 3
            
        recommendation_text = self.content.GLOBAL_RECOMMENDATIONS.get(final_level_id, "–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π")
        
        total_score = (res.get('c1_score') or 0) + (res.get('c2_score') or 0) + (res.get('c3_score') or 0) + (res.get('c4_score') or 0)
        
        text = (
            f"üèÜ <b>–û–ë–©–ò–ô –í–´–í–û–î</b>\n\n"
            f"{recommendation_text}\n\n"
            f"<i>–û–±—â–∞—è —Å—É–º–º–∞ –±–∞–ª–ª–æ–≤: {total_score}</i>"
        )
        
        self.db.save_result(chat_id, 'total', text, total_score)
        kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–ú–µ–Ω—é", callback_data="menu"))
        self.bot.send_message(chat_id, text, reply_markup=kb, parse_mode="HTML")

    def handle_admin(self, message: types.Message):
        if message.from_user.id not in ADMIN_IDS:
            return 
        
        kb = types.InlineKeyboardMarkup()
        kb.add(types.InlineKeyboardButton("üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç (Excel)", callback_data="admin_export"))
        self.bot.send_message(message.chat.id, "üîß <b>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>", reply_markup=kb, parse_mode="HTML")

    def handle_export(self, call: types.CallbackQuery):
        if call.from_user.id not in ADMIN_IDS:
             return self.bot.answer_callback_query(call.id, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        
        self.bot.answer_callback_query(call.id, "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞...")
        rows = self.db.get_all_results()
        
        if not rows:
            return self.bot.send_message(call.message.chat.id, "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞.")
            
        wb = Workbook()
        ws = wb.active
        ws.title = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã"
        
        def get_d(row, col):
            try: return json.loads(row[col]) if row[col] else {}
            except: return {}

        headers = ["User ID", "–§–ò–û"]
        

        headers.extend(["C1 Total Score", "C1 Level"])
        headers.extend([f"C1 M1 Q{i+1}" for i in range(11)])
        headers.extend([f"C1 M2 Q{i+1}" for i in range(18)]) 
        headers.extend([f"C1 M3 Q{i+1}" for i in range(13)]) 
        headers.extend(["C2 Total Score", "C2 Level"])
        headers.extend([f"C2 M4 Q{i+1} (Score)" for i in range(7)])
        headers.extend([f"C2 M5 Q{i+1}" for i in range(13)])
        headers.extend([f"C2 M6 Q{i+1}" for i in range(8)])
        headers.extend(["C3 Total Score", "C3 Level"])
        headers.extend([f"C3 M7 Q{i+1}" for i in range(18)])
        headers.extend([f"C3 M8 Q{i+1}" for i in range(6)])
        headers.extend([f"C3 M10 Q{i+1}" for i in range(9)])
        headers.extend(["C4 Score (AI)", "C4 Level", "C4 Answers (Text)"])
        headers.append("Global Recommendation")
        
        ws.append(headers)
        
        for row in rows:
            r = dict(row)
            c1_d = get_d(r, 'c1_details')
            c2_d = get_d(r, 'c2_details')
            c3_d = get_d(r, 'c3_details')
            c4_d = get_d(r, 'c4_details')
            
            data = [r['user_id'], r.get('fio', '')]
            data.extend([r.get('c1_score'), r.get('c1_level')])
            m1_sel = set(c1_d.get('m1', []))
            for i in range(1, 12):
                data.append(self.content.M1_ITEMS.get(i, 0) if i in m1_sel else 0)
            m2_res = c1_d.get('m2', [])
            for i in range(18): data.append(m2_res[i] if i < len(m2_res) else 0)
            m3_sel = set(c1_d.get('m3', []))
            for i in range(1, 14):
                data.append(self.content.M3_ITEMS.get(i, 0) if i in m3_sel else 0)
            data.extend([r.get('c2_score'), r.get('c2_level')])
            m4_res = c2_d.get('m4', [])
            for i in range(7): data.append(m4_res[i] if i < len(m4_res) else 0)
            m5_sel = set(c2_d.get('m5', []))
            for i in range(1, 14):
                data.append(self.content.M5_ITEMS.get(i, 0) if i in m5_sel else 0)
            m6_res = c2_d.get('m6', [])
            for i in range(8): data.append(m6_res[i] if i < len(m6_res) else 0)
            data.extend([r.get('c3_score'), r.get('c3_level')])
            m7_res = c3_d.get('m7', [])
            for i in range(18): data.append(m7_res[i] if i < len(m7_res) else 0)
            m8_res = c3_d.get('m8', [])
            for i in range(6): data.append(m8_res[i] if i < len(m8_res) else 0)
            m10_res = c3_d.get('m10', [])
            for i in range(9): data.append(m10_res[i] if i < len(m10_res) else 0)
            c4_text = " || ".join([f"{x[0]}: {x[1]}" for x in c4_d]) if isinstance(c4_d, list) else ""
            data.extend([r.get('c4_score'), r.get('c4_level'), c4_text])
            data.append(r.get('total_res'))
            ws.append(data)
            

        buf = io.BytesIO()
        wb.save(buf)
        buf.seek(0)
        
        self.bot.send_document(
            call.message.chat.id, 
            buf, 
            visible_file_name="results_detailed_fio.xlsx",
            caption="üìä –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å –§–ò–û –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –±–∞–ª–ª–∞–º–∏."
        )

    def c1_intro(self, call):
        if self.db.get_results(call.message.chat.id).get('c1_res'): return self.bot.answer_callback_query(call.id, "–ü—Ä–æ–π–¥–µ–Ω–æ!")
        kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–ù–∞—á–∞—Ç—å", callback_data="c1_real_start"))
        self._safe_edit(call.message.chat.id, call.message.message_id, self.content.CRITERIA_INTROS['c1'], reply_markup=kb)
        
    def c2_intro(self, call):
        if self.db.get_results(call.message.chat.id).get('c2_res'): return self.bot.answer_callback_query(call.id, "–ü—Ä–æ–π–¥–µ–Ω–æ!")
        kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–ù–∞—á–∞—Ç—å", callback_data="c2_real_start"))
        self._safe_edit(call.message.chat.id, call.message.message_id, self.content.CRITERIA_INTROS['c2'], reply_markup=kb)

    def c3_intro(self, call):
        if self.db.get_results(call.message.chat.id).get('c3_res'): return self.bot.answer_callback_query(call.id, "–ü—Ä–æ–π–¥–µ–Ω–æ!")
        kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–ù–∞—á–∞—Ç—å", callback_data="c3_real_start"))
        self._safe_edit(call.message.chat.id, call.message.message_id, self.content.CRITERIA_INTROS['c3'], reply_markup=kb)

    def c1_start_test(self, call):
        self.bot.send_message(call.message.chat.id, self.content.METHODOLOGY_INSTRUCTIONS['text_m1'], parse_mode="HTML")
        self._get_session(call.message.chat.id).c1_data = {
            'm1_answers': set(), 'm2_idx': 0, 'm2_answers': [], 'm3_answers': set()
        }
        self._render_checkbox_step(call.message.chat.id, call.message.message_id, "c1_m1", self.content.M1_TEXTS, set(), "–ú.1 –¶–µ–Ω–Ω–æ—Å—Ç–∏", "c1_m1_done")

    def c2_start_test(self, call):
        self._get_session(call.message.chat.id).c2_data = {'m4_idx': 0, 'm4_score': 0, 'm4_temp': set(), 'm4_answers': [], 'm5_answers': set(), 'm6_idx': 0, 'm6_answers': [], 'm6_score': 0}
        self.bot.send_message(call.message.chat.id, self.content.METHODOLOGY_INSTRUCTIONS['text_m5'], parse_mode="HTML")
        self._render_m4_step(call.message.chat.id, call.message.message_id)

    def c3_start_test(self, call):
        self._get_session(call.message.chat.id).c3_data = {'m7_idx': 0, 'm7_answers': [], 'm8_idx': 0, 'm8_answers': [], 'm10_idx': 0, 'm10_answers': []}
        self.bot.send_message(call.message.chat.id, self.content.METHODOLOGY_INSTRUCTIONS['text_m8'], parse_mode="HTML") 
        self._render_sequence_step(call.message.chat.id, call.message.message_id, "c3_seq_m7", self.content.GENERIC_TESTS['m7'], 0, "–ú.8 –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª")

    def c1_m1_handler(self, call):
        if call.data == "c1_m1_done": 
            self.bot.send_message(call.message.chat.id, self.content.METHODOLOGY_INSTRUCTIONS['text_m2'], parse_mode="HTML")
            self._render_sequence_step(call.message.chat.id, call.message.message_id, "c1_m2", self.content.M2_QS, 0, "–ú.2 –°–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ")
        else: self._handle_checkbox_toggle(call, "c1_m1", self.content.M1_TEXTS, self._get_session(call.message.chat.id).c1_data['m1_answers'], "–ú.1", "c1_m1_done")
    
    def c1_m2_handler(self, call):
        d = self._get_session(call.message.chat.id).c1_data
        if "ans" in call.data:
            score = int(call.data.split("_")[3])
            d['m2_answers'].append(score)
            d['m2_idx'] += 1
            self._render_sequence_step(call.message.chat.id, call.message.message_id, "c1_m2", self.content.M2_QS, d['m2_idx'], "–ú.2", "c1_m3_start")
        elif "next" in call.data: 
            self.bot.send_message(call.message.chat.id, self.content.METHODOLOGY_INSTRUCTIONS['text_m3'], parse_mode="HTML")
            self._render_checkbox_step(call.message.chat.id, call.message.message_id, "c1_m3", self.content.M3_TEXTS, d['m3_answers'], "–ú.3", "c1_done")
    
    def c1_m3_handler(self, call): self._handle_checkbox_toggle(call, "c1_m3", self.content.M3_TEXTS, self._get_session(call.message.chat.id).c1_data['m3_answers'], "–ú.3", "c1_done")
    
    def c1_finish(self, call):
        d = self._get_session(call.message.chat.id).c1_data
        s1 = sum([self.content.M1_ITEMS[k] for k in d['m1_answers']])
        s2 = sum(d['m2_answers'])
        s3 = sum([self.content.M3_ITEMS[k] for k in d['m3_answers']])
        l1, l2, l3 = self._calc_level(s1, 3, 5), self._calc_level(s2, 27, 41), self._calc_level(s3, 2, 3)
        details = {'m1': list(d['m1_answers']), 'm2': d['m2_answers'], 'm3': list(d['m3_answers'])}
        self._finalize(call.message.chat.id, call.message.message_id, 'c1', s1+s2+s3, [s1,s2,s3], [l1,l2,l3], ["–ú1","–ú2","–ú3"], details)

    def c2_m4_handler(self, call):
        d = self._get_session(call.message.chat.id).c2_data
        if "s_" in call.data:
            score = float(call.data.split("_")[3])
            d['m4_score'] += score 
            d['m4_answers'].append(score)
            d['m4_idx'] += 1
            self._render_m4_step(call.message.chat.id, call.message.message_id)
        elif "m_" in call.data:
            oid = int(call.data.split("_")[3])
            if oid in d['m4_temp']: d['m4_temp'].remove(oid)
            else: d['m4_temp'].add(oid)
            self._render_m4_step(call.message.chat.id, call.message.message_id)
        elif "confirm" in call.data:
            q = self.content.M4_QS[d['m4_idx']]
            score = len(d['m4_temp'].intersection(q['c'])) * q['w']
            d['m4_score'] += score
            d['m4_answers'].append(score)
            d['m4_temp'] = set(); d['m4_idx'] += 1
            self._render_m4_step(call.message.chat.id, call.message.message_id)
            
    def c2_m5_handler(self, call):
        if call.data == "c2_m5_done": 
            self.bot.send_message(call.message.chat.id, self.content.METHODOLOGY_INSTRUCTIONS['text_m7'], parse_mode="HTML")
            self._render_sequence_step(call.message.chat.id, call.message.message_id, "c2_m6", self.content.M6_QS, 0, "–ú.7")
        else: self._handle_checkbox_toggle(call, "c2_m5", self.content.M5_TEXTS, self._get_session(call.message.chat.id).c2_data['m5_answers'], "–ú.6", "c2_m5_done")
        
    def c2_m6_handler(self, call):
        d = self._get_session(call.message.chat.id).c2_data
        if "ans" in call.data:
            score = int(call.data.split("_")[3])
            d['m6_score'] += score
            d['m6_answers'].append(score)
            d['m6_idx'] += 1
            self._render_sequence_step(call.message.chat.id, call.message.message_id, "c2_m6", self.content.M6_QS, d['m6_idx'], "–ú.7", "finish")
        elif "next" in call.data:
            s4, s5, s6 = sum(d['m4_answers']), sum([self.content.M5_ITEMS[k] for k in d['m5_answers']]), sum(d['m6_answers'])
            details = {'m4': d['m4_answers'], 'm5': list(d['m5_answers']), 'm6': d['m6_answers']}
            self._finalize(call.message.chat.id, call.message.message_id, 'c2', s4+s5+s6, [s4,s5,s6], [self._calc_level(s4,6,10), self._calc_level(s5,6,10), self._calc_level(s6,12,18)], ["–ú5","–ú6","–ú7"], details)

    def c3_seq_handler(self, call):
        d = self._get_session(call.message.chat.id).c3_data
        test, action = call.data.split("_")[2], call.data.split("_")[3]
        if action == "ans":
            score = int(call.data.split("_")[4])
            d[f'{test}_answers'].append(score)
            d[f'{test}_idx'] += 1
            qs = self.content.GENERIC_TESTS[test]
            if d[f'{test}_idx'] < len(qs): 
                title_map = {'m7': "–ú.8", 'm8': "–ú.9", 'm10': "–ú.10"}
                self._render_sequence_step(call.message.chat.id, call.message.message_id, f"c3_seq_{test}", qs, d[f'{test}_idx'], title_map.get(test, test.upper()))
            else:
                nxt = "m8" if test=="m7" else ("m10" if test=="m8" else "finish")
                if nxt == "finish":
                    s7, s8, s10 = sum(d['m7_answers']), sum(d['m8_answers']), sum(d['m10_answers'])
                    details = {'m7': d['m7_answers'], 'm8': d['m8_answers'], 'm10': d['m10_answers']}
                    self._finalize(call.message.chat.id, call.message.message_id, 'c3', s7+s8+s10, [s7,s8,s10], [self._calc_level(s7,27,41), self._calc_level(s8,5,14), self._calc_level(s10,10,15)], ["–ú8","–ú9","–ú10"], details)
                else:
                    intro_key = 'text_m9' if nxt == 'm8' else 'text_m10'
                    title_next = "–ú.9" if nxt == 'm8' else "–ú.10"
                    
                    self.bot.send_message(call.message.chat.id, self.content.METHODOLOGY_INSTRUCTIONS.get(intro_key, ""), parse_mode="HTML")
                    self._render_sequence_step(call.message.chat.id, call.message.message_id, f"c3_seq_{nxt}", self.content.GENERIC_TESTS[nxt], 0, title_next)

    def _handle_checkbox_toggle(self, call, prefix, items, selected, title, done_cb):
        idx = int(call.data.split("_")[2])
        if idx in selected: selected.remove(idx)
        else: selected.add(idx)
        self._render_checkbox_step(call.message.chat.id, call.message.message_id, prefix, items, selected, title, done_cb)

    def _render_checkbox_step(self, chat_id, msg_id, prefix, items, selected, title, done_cb):
        msg = f"<b>{title}</b>\n–í—ã–±–µ—Ä–∏—Ç–µ (—Ü–∏—Ñ—Ä—ã):\n"
        kb = types.InlineKeyboardMarkup(row_width=5)
        btns = []
        for i, (k, v) in enumerate(items.items()):
            msg += f"{k}. {v} {'‚úÖ' if k in selected else ''}\n"
            btns.append(types.InlineKeyboardButton(f"{k} {'‚úÖ' if k in selected else ''}", callback_data=f"{prefix}_{k}"))
        kb.add(*btns)
        kb.add(types.InlineKeyboardButton("–î–∞–ª–µ–µ ‚û°Ô∏è", callback_data=done_cb))
        self._safe_edit(chat_id, msg_id, msg, reply_markup=kb)

    def _render_sequence_step(self, chat_id, msg_id, prefix, qs_list, idx, title, next_callback=None):
        if idx >= len(qs_list):
            # if next_callback == "finish": return  <-- REMOVED THIS LINE
            kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–î–∞–ª–µ–µ", callback_data=f"{prefix}_next_callback"))
            self._safe_edit(chat_id, msg_id, "–†–∞–∑–¥–µ–ª –∑–∞–≤–µ—Ä—à–µ–Ω.", reply_markup=kb)
            return
        q, opts = qs_list[idx]
        msg = f"<b>{title} ({idx+1}/{len(qs_list)})</b>\n\n{q}\n"
        kb = types.InlineKeyboardMarkup(row_width=5)
        btns = []
        for i, (t, s) in enumerate(opts):
            msg += f"{i+1}. {t}\n"
            btns.append(types.InlineKeyboardButton(str(i+1), callback_data=f"{prefix}_ans_{s}"))
        kb.add(*btns)
        self._safe_edit(chat_id, msg_id, msg, reply_markup=kb)

    def _render_m4_step(self, chat_id, msg_id):
        d = self._get_session(chat_id).c2_data
        if d['m4_idx'] >= len(self.content.M4_QS):
            self.bot.send_message(chat_id, self.content.METHODOLOGY_INSTRUCTIONS['text_m6'], parse_mode="HTML")
            self._render_checkbox_step(chat_id, msg_id, "c2_m5", self.content.M5_TEXTS, d['m5_answers'], "–ú.6", "c2_m5_done")
            return
        q = self.content.M4_QS[d['m4_idx']]
        msg = f"<b>–ú.5 ({d['m4_idx']+1})</b>\n{q['q']}\n"
        kb = types.InlineKeyboardMarkup(row_width=5)
        btns = []
        if q['t'] == 's':
            for i, (txt, pt) in enumerate(q['o']):
                msg += f"{i+1}. {txt}\n"
                btns.append(types.InlineKeyboardButton(str(i+1), callback_data=f"c2_m4_s_{pt}"))
            kb.add(*btns)
        else:
            for i, txt in enumerate(q['o']):
                s_icon = "‚úÖ" if i in d['m4_temp'] else ""
                msg += f"{i+1}. {txt} {s_icon}\n"
                btns.append(types.InlineKeyboardButton(f"{i+1}{s_icon}", callback_data=f"c2_m4_m_{i}"))
            kb.add(*btns)
            kb.add(types.InlineKeyboardButton("–û–ö", callback_data="c2_m4_confirm"))
        self._safe_edit(chat_id, msg_id, msg, reply_markup=kb)

    def _finalize(self, chat_id, msg_id, key, total, scores, levels, labels, details=None):
        avg = sum(levels)/len(levels)
        fl = 1 if avg < 1.6 else (2 if avg < 2.4 else 3)
        
        txt = f"üìä <b>{key.upper()}</b>\n"
        for i, l in enumerate(labels): txt += f"{l}: {scores[i]} ({levels[i]})\n"
        
        level_name = self.content.LEVEL_NAMES[fl]
        full_description = self.content.FULL_DESCRIPTIONS[key][fl]
        
        txt += f"\n–ò—Ç–æ–≥: <b>{level_name}</b>\n\n{full_description}"
        
        self.db.save_result(chat_id, key, txt, total, fl, details=details)
        kb = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("–ú–µ–Ω—é", callback_data="menu"))
        self._safe_edit(chat_id, msg_id, txt, reply_markup=kb)

    def run(self):
        logging.info("Bot started...")
        self.bot.infinity_polling()

if __name__ == "__main__":
    db_inst = DatabaseManager(DB_NAME)
    bot_inst = QuizBot(API_TOKEN, db_inst)
    bot_inst.run()
